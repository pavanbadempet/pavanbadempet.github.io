<!-- Command Palette Modal -->
<div id="command-palette" class="command-palette-overlay" style="display: none;">
    <div class="command-palette-modal">
        <div class="cp-header">
            <div class="cp-mode-icon">
                <i class="fas fa-sparkles" id="cp-mode-icon"></i>
            </div>
            <input type="text" id="cp-input" placeholder="Ask AI about Pavan... (or type / for commands)"
                autocomplete="off">
            <div class="cp-actions">
                <span id="cp-status-tag" class="cp-status-tag">AI Active</span>
                <span class="cp-esc">ESC</span>
            </div>
        </div>

        <div class="cp-body">
            <!-- Chat Mode Container -->
            <div id="cp-chat-container">
                <div class="cp-message bot">
                    <div class="cp-avatar"><i class="fas fa-robot"></i></div>
                    <div class="cp-text">Hello! I'm Pavan's AI Assistant. Ask me anything about his projects, skills, or
                        experience.</div>
                </div>
            </div>

            <!-- Command Mode Container (Hidden by default) -->
            <div id="cp-commands-container" style="display:none;">
                <div class="cp-section">Navigation</div>
                <a href="{{ '/portfolio/' | relative_url }}" class="cp-item" data-tags="projects portfolio work code">
                    <i class="fas fa-layer-group"></i>
                    <span>Go to Projects</span>
                    <span class="cp-shortcut">P</span>
                </a>
                <a href="{{ '/resume/' | relative_url }}" class="cp-item" data-tags="resume cv experience job work">
                    <i class="fas fa-file-alt"></i>
                    <span>Go to Resume</span>
                    <span class="cp-shortcut">R</span>
                </a>
                <a href="{{ '/contacts/' | relative_url }}" class="cp-item" data-tags="contact email phone hire">
                    <i class="fas fa-paper-plane"></i>
                    <span>Contact Me</span>
                    <span class="cp-shortcut">C</span>
                </a>
                <a href="{{ '/' | relative_url }}" class="cp-item" data-tags="home start landing">
                    <i class="fas fa-home"></i>
                    <span>Go Home</span>
                    <span class="cp-shortcut">H</span>
                </a>

                <!-- Search Results Placeholder -->
                <div id="cp-search-results"></div>

                <div class="cp-section">Actions</div>
                <div class="cp-item" id="cp-copy-email" data-tags="email copy mail">
                    <i class="fas fa-envelope"></i>
                    <span>Copy Email</span>
                </div>
                <a href="https://drive.google.com/file/d/1gppjKAn5s9W06uH4ajoj7Ha2H13zEPkq/view?usp=sharing"
                    target="_blank" class="cp-item" onclick="togglePalette();" data-tags="resume cv pdf download">
                    <i class="fas fa-file-pdf"></i>
                    <span>View Resume PDF</span>
                </a>
            </div>
        </div>
        <div class="cp-footer">
            <span></span>
            <span class="cp-hint">Type <b>/</b> to switch modes</span>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    /* Command Palette Styles */
    .command-palette-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        z-index: 999999;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        /* Changed to flex-start with margin for better mobile view, but let's try center-ish */
        padding-top: 15vh;
        /* Keep top padding but reduce it and ensure it handles overflow */
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .command-palette-overlay.open {
        opacity: 1;
    }

    /* Center it properly and handle height */
    .command-palette-overlay {
        align-items: flex-start;
        padding-top: 80px;
        /* Space for navbar if needed */
    }

    @media (min-height: 600px) {
        .command-palette-overlay {
            align-items: center;
            padding-top: 0;
        }
    }

    .command-palette-modal {
        width: 100%;
        max-width: 650px;
        background: #1E1E1E;
        border-radius: 12px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        max-height: 80vh;
        /* Prevent it from being taller than screen */
        margin: 0 15px;
        /* Side margins on mobile */
        transform: scale(0.95);
        opacity: 0;
        transition: all 0.2s ease;
    }

    .command-palette-overlay.open .command-palette-modal {
        transform: scale(1);
        opacity: 1;
    }

    .cp-header {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        background: #1E1E1E;
        flex-shrink: 0;
        /* Keep header from shrinking */
    }

    .cp-mode-icon {
        color: #4bffa5;
        font-size: 1.2em;
        width: 24px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .cp-mode-icon i.fa-sparkles {
        background: none;
        -webkit-text-fill-color: initial;
        color: #4bffa5;
        text-shadow: 0 0 10px rgba(75, 255, 165, 0.4);
    }

    #cp-input {
        background: transparent;
        border: none;
        color: #fff;
        font-family: 'Roboto', sans-serif;
        font-size: 1.1em;
        flex-grow: 1;
        outline: none;
        padding: 0;
        margin: 0;
        height: 100%;
        line-height: normal;
        /* Fix vertical align */
    }

    #cp-input::placeholder {
        color: #666;
    }

    .cp-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-left: auto;
    }

    .cp-esc {
        background: rgba(255, 255, 255, 0.1);
        color: #aaa;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.75em;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .cp-status-tag {
        background: #4bffa5;
        color: #000;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.7em;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 0 10px rgba(75, 255, 165, 0.2);
    }

    .cp-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0;
        min-height: 200px;
        scroll-behavior: smooth;
        /* Scrollbar styling */
        scrollbar-width: thin;
        scrollbar-color: #333 transparent;
    }

    .cp-body::-webkit-scrollbar {
        width: 6px;
    }

    .cp-body::-webkit-scrollbar-thumb {
        background-color: #333;
        border-radius: 3px;
    }

    /* Messages */
    #cp-chat-container {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .cp-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 0.9em;
    }

    .cp-message.bot .cp-avatar {
        background: rgba(75, 255, 165, 0.1);
        color: #4bffa5;
        border: 1px solid rgba(75, 255, 165, 0.2);
    }

    .cp-message.user .cp-avatar {
        background: #333;
        color: #ccc;
    }

    .cp-text {
        background: #252526;
        padding: 12px 18px;
        border-radius: 12px;
        color: #ddd;
        max-width: 90%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        line-height: 1.6;
        font-size: 0.95em;
    }

    .cp-message.bot .cp-text {
        background: rgba(255, 255, 255, 0.03);
        border-top-left-radius: 4px;
    }

    .cp-message.user .cp-text {
        background: #264f78;
        color: white;
        border-top-right-radius: 4px;
    }

    .cp-text ul {
        padding-left: 20px;
        margin: 8px 0;
    }

    .cp-text li {
        margin-bottom: 4px;
    }

    .cp-text strong {
        color: #fff;
        font-weight: 600;
    }

    .cp-footer {
        padding: 10px 20px;
        background: #1E1E1E;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 0.75em;
        color: #666;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .cp-hint b {
        color: #eee;
        background: rgba(255, 255, 255, 0.1);
        padding: 0 4px;
        border-radius: 3px;
        font-weight: 500;
    }

    /* Thinking Animation */
    .thinking-dots {
        display: flex;
        gap: 4px;
        padding: 6px 2px;
    }

    .thinking-dots span {
        width: 6px;
        height: 6px;
        background: #4bffa5;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
        opacity: 0.6;
    }
</style>

<script>
    let paletteState = { isOpen: false, mode: 'ai', selectedIndex: 0 };
    let contextData = null;
    let chatHistory = [];

    // --- Core Functions ---
    function togglePalette() {
        const palette = document.getElementById('command-palette');
        const input = document.getElementById('cp-input');
        if (paletteState.isOpen) {
            palette.classList.remove('open');
            setTimeout(() => { palette.style.display = 'none'; }, 200);
            document.body.style.overflow = '';
        } else {
            palette.style.display = 'flex';
            void palette.offsetWidth;
            palette.classList.add('open');
            input.value = '';
            input.focus();
            document.body.style.overflow = 'hidden';
            // Default to AI mode
            setMode('ai');
            if (!contextData) loadContext();
        }
        paletteState.isOpen = !paletteState.isOpen;
    }

    function setMode(mode) {
        paletteState.mode = mode;
        const icon = document.getElementById('cp-mode-icon');
        const chatContainer = document.getElementById('cp-chat-container');
        const cmdContainer = document.getElementById('cp-commands-container');
        const status = document.getElementById('cp-status-tag');
        const input = document.getElementById('cp-input');

        if (mode === 'ai') {
            icon.className = 'fas fa-sparkles';
            chatContainer.style.display = 'flex';
            cmdContainer.style.display = 'none';
            status.textContent = 'AI Active';
            status.style.background = '#4bffa5';
            status.style.color = '#000';
            status.style.boxShadow = '0 0 10px rgba(75, 255, 165, 0.3)';
            input.placeholder = "Ask AI about Pavan... (or type / for commands)";
        } else {
            icon.className = 'fas fa-search';
            chatContainer.style.display = 'none';
            cmdContainer.style.display = 'block';
            status.textContent = 'CMD Mode';
            status.style.background = '#007acc';
            input.placeholder = "Search commands... (backspace to clear /)";
        }
    }

    async function loadContext() {
        try {
            const response = await fetch('{{ "/search.json" | relative_url }}?v=' + Date.now());
            const data = await response.json();
            // Pre-process context into a string
            contextData = "Here is Pavan's portfolio data:\n" + data.map(item =>
                `- Title: ${item.title}\n  Type: ${item.category}\n  Tags: ${item.tags}\n  Content Sum: ${item.content.substring(0, 300)}...`
            ).join('\n\n');
        } catch (e) { console.error("Context load failed", e); }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('cp-input');

        // Mode Switching & Input logic
        input.addEventListener('input', (e) => {
            const val = e.target.value;

            if (paletteState.mode === 'ai' && val.startsWith('/')) {
                setMode('command');
                input.value = ''; // Clear the /
            } else if (paletteState.mode === 'command' && val === '' && e.inputType === 'deleteContentBackward') {
                setMode('ai');
            }

            if (paletteState.mode === 'command') {
                // Classic filter logic (Static Items)
                const query = val.toLowerCase();
                document.querySelectorAll('.cp-item').forEach(item => {
                    const text = item.innerText.toLowerCase();
                    const tags = item.getAttribute('data-tags') || '';
                    item.classList.toggle('hidden', !(text.includes(query) || tags.includes(query)));
                });
                // Dynamic Search (Blog posts / Projects)
                performSearch(query);
            }
        });

        // Enter Key Handler
        input.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (paletteState.mode === 'command') {
                    // Execute command (first visible)
                    const visible = document.querySelector('.cp-item:not(.hidden)') || document.querySelector('.cp-search-result');
                    if (visible) visible.click();
                } else {
                    // Send message to AI
                    handleUserMessage(input.value);
                    input.value = '';
                }
            }
            // Classic navigation for command mode (simplified)
            if (e.key === 'Escape') {
                togglePalette();
            }
        });

        // Global Shortcut
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault(); togglePalette();
            }
        });

        // Copy Email Action
        const copyEmailBtn = document.getElementById('cp-copy-email');
        if (copyEmailBtn) {
            copyEmailBtn.addEventListener('click', () => {
                navigator.clipboard.writeText("pavan9b@gmail.com").then(() => {
                    togglePalette();
                });
            });
        }
    });

    // --- AI Logic (Pollinations.ai) ---
    async function handleUserMessage(msg) {
        if (!msg.trim()) return;

        addUserMessage(msg);
        const thinkingId = addThinking();

        try {
            const response = await callPollinations(msg);
            removeMessage(thinkingId);
            addBotMessage(response);
        } catch (error) {
            removeMessage(thinkingId);
            addBotMessage("Error: " + error.message);
        }
    }

    async function callPollinations(prompt) {
        const url = 'https://text.pollinations.ai/';

        const systemPrompt = `You are a helpful assistant for Pavan Badempet's portfolio website. 
        Use the following JSON data as your knowledge base about Pavan: ${contextData}
        
        Rules:
        1. Keep answers concise (under 3 sentences preferably).
        2. Be professional but friendly.
        3. If you don't know, suggest checking the Resume or Projects page.
        4. Format with Markdown (bold, lists).`;

        const messages = [
            { role: "system", content: systemPrompt },
            ...chatHistory,
            { role: "user", content: prompt }
        ];

        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ messages: messages, model: 'openai' })
        });

        if (!res.ok) throw new Error("Pollinations API Error");

        const answer = await res.text(); // Pollinations returns raw text string

        // Update history
        chatHistory.push({ role: "user", content: prompt });
        chatHistory.push({ role: "assistant", content: answer });

        return answer;
    }

    // --- Chat UI Helpers ---
    function addUserMessage(text) {
        const div = document.createElement('div');
        div.className = 'cp-message user';
        div.innerHTML = `<div class="cp-avatar"><i class="fas fa-user"></i></div><div class="cp-text">${escapeHtml(text)}</div>`;
        document.getElementById('cp-chat-container').appendChild(div);
        scrollToBottom();
    }

    function addBotMessage(markdown) {
        const div = document.createElement('div');
        div.className = 'cp-message bot';
        // Parse markdown using marked.js
        const html = marked.parse(markdown);
        div.innerHTML = `<div class="cp-avatar"><i class="fas fa-robot"></i></div><div class="cp-text">${html}</div>`;
        document.getElementById('cp-chat-container').appendChild(div);
        scrollToBottom();
    }

    function addThinking() {
        const id = 'thinking-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = 'cp-message bot';
        div.innerHTML = `<div class="cp-avatar"><i class="fas fa-robot"></i></div>
            <div class="cp-text"><div class="thinking-dots"><span></span><span></span><span></span></div></div>`;
        document.getElementById('cp-chat-container').appendChild(div);
        scrollToBottom();
        return id;
    }

    function removeMessage(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    function scrollToBottom() {
        const container = document.querySelector('.cp-body');
        container.scrollTop = container.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>