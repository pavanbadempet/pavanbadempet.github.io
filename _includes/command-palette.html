<!-- Command Palette Modal -->
<div id="command-palette" class="command-palette-overlay" style="display: none;">
    <div class="command-palette-modal">
        <div class="cp-header">
            <i class="fas fa-search"></i>
            <input type="text" id="cp-input" placeholder="Type a command or search..." autocomplete="off">
            <span class="cp-esc">ESC</span>
        </div>
        <div class="cp-body">
            <div class="cp-section">Navigation</div>
            <a href="{{ '/resume/' | relative_url }}" class="cp-item" data-tags="resume cv experience job work">
                <i class="fas fa-file-alt"></i>
                <span>Go to Resume</span>
                <span class="cp-shortcut">R</span>
            </a>
            <a href="{{ '/portfolio/' | relative_url }}" class="cp-item" data-tags="projects portfolio work code">
                <i class="fas fa-layer-group"></i>
                <span>Go to Projects</span>
                <span class="cp-shortcut">P</span>
            </a>
            <a href="{{ '/contacts/' | relative_url }}" class="cp-item" data-tags="contact email phone hire">
                <i class="fas fa-paper-plane"></i>
                <span>Contact Me</span>
                <span class="cp-shortcut">C</span>
            </a>
            <a href="{{ '/' | relative_url }}" class="cp-item" data-tags="home start landing">
                <i class="fas fa-home"></i>
                <span>Go Home</span>
                <span class="cp-shortcut">H</span>
            </a>

            <div class="cp-section">Actions</div>
            <div class="cp-item" id="cp-copy-email" data-tags="email copy mail">
                <i class="fas fa-envelope"></i>
                <span>Copy Email</span>
            </div>
            <div class="cp-item" onclick="window.print()" data-tags="print pdf save">
                <i class="fas fa-print"></i>
                <span>Print Resume</span>
            </div>
        </div>
    </div>
</div>

<style>
    /* Command Palette Styles */
    .command-palette-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 10vh;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .command-palette-overlay.open {
        opacity: 1;
    }

    .command-palette-modal {
        width: 100%;
        max-width: 600px;
        background: #1e1e1e;
        /* VS Code Dark */
        border-radius: 8px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        border: 1px solid #333;
        transform: translateY(-20px);
        transition: transform 0.2s ease;
    }

    .command-palette-overlay.open .command-palette-modal {
        transform: translateY(0);
    }

    .cp-header {
        padding: 15px 20px;
        border-bottom: 1px solid #333;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .cp-header i {
        color: #888;
        font-size: 1.2em;
    }

    #cp-input {
        background: transparent;
        border: none;
        color: #fff;
        font-family: 'Roboto', sans-serif;
        font-size: 1.2em;
        width: 100%;
        outline: none;
        padding: 0;
        margin: 0;
        /* Override default input styles */
        height: auto;
    }

    /* Force override conflicting input styles from main theme */
    #cp-input:focus {
        border-bottom: none;
    }

    .cp-esc {
        background: #333;
        color: #aaa;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8em;
    }

    .cp-body {
        max-height: 400px;
        overflow-y: auto;
        padding: 10px 0;
    }

    .cp-section {
        padding: 8px 20px;
        color: #666;
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }

    .cp-item {
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        cursor: pointer;
        color: #ccc;
        text-decoration: none;
        border-left: 3px solid transparent;
        transition: background 0.1s;
    }

    .cp-item:hover,
    .cp-item.selected {
        background: #2a2d2e;
        color: #fff;
        border-left: 3px solid #007acc;
        /* VS Code Blue */
        text-decoration: none;
    }

    .cp-item i {
        width: 20px;
        text-align: center;
        color: #888;
    }

    .cp-item:hover i,
    .cp-item.selected i {
        color: #fff;
    }

    .cp-shortcut {
        margin-left: auto;
        background: #333;
        color: #aaa;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8em;
        font-family: monospace;
    }

    .cp-item.hidden {
        display: none;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const palette = document.getElementById('command-palette');
        const input = document.getElementById('cp-input');
        const items = document.querySelectorAll('.cp-item');
        let isOpen = false;
        let selectedIndex = 0;

        // Open/Close Logic
        function togglePalette() {
            if (isOpen) {
                palette.classList.remove('open');
                setTimeout(() => { palette.style.display = 'none'; }, 200);
                document.body.style.overflow = '';
            } else {
                palette.style.display = 'flex';
                // Force reflow
                void palette.offsetWidth;
                palette.classList.add('open');
                input.value = '';
                filterItems('');
                input.focus();
                document.body.style.overflow = 'hidden';
                selectedIndex = 0;
                updateSelection();
            }
            isOpen = !isOpen;
        }

        // Shortcut: Ctrl+K or Cmd+K
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                togglePalette();
            }
            if (e.key === 'Escape' && isOpen) {
                togglePalette();
            }

            if (!isOpen) return;

            // Navigation
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % getVisibleItems().length;
                updateSelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const visible = getVisibleItems();
                selectedIndex = (selectedIndex - 1 + visible.length) % visible.length;
                updateSelection();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const visible = getVisibleItems();
                if (visible[selectedIndex]) {
                    visible[selectedIndex].click();
                }
            }
        });

        // Close on click outside
        palette.addEventListener('click', (e) => {
            if (e.target === palette) togglePalette();
        });

        // Filter Logic
        input.addEventListener('input', (e) => {
            filterItems(e.target.value.toLowerCase());
            selectedIndex = 0;
            updateSelection();
        });

        function filterItems(query) {
            items.forEach(item => {
                const text = item.innerText.toLowerCase();
                const tags = item.getAttribute('data-tags') || '';
                if (text.includes(query) || tags.includes(query)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        function getVisibleItems() {
            return Array.from(items).filter(item => !item.classList.contains('hidden'));
        }

        function updateSelection() {
            items.forEach(item => item.classList.remove('selected'));
            const visible = getVisibleItems();
            if (visible[selectedIndex]) {
                visible[selectedIndex].classList.add('selected');
                visible[selectedIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        // Copy Email Action
        const copyEmailBtn = document.getElementById('cp-copy-email');
        if (copyEmailBtn) {
            copyEmailBtn.addEventListener('click', () => {
                navigator.clipboard.writeText("pavan9b@gmail.com").then(() => {
                    togglePalette();
                    // Optional: Show a toast? relying on the existing system for now
                });
            });
        }
    });
</script>